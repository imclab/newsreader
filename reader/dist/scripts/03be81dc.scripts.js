"use strict";angular.module("readerApp",["ngCookies","ngResource","ngSanitize","ngRoute","http-auth-interceptor","infinite-scroll","truncate","wu.masonry","angularMoment","ui.bootstrap","ngProgressLite"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/stream",{templateUrl:"views/items.html",controller:"ItemsCtrl"}).when("/settings",{templateUrl:"views/settings.html",controller:"SettingsCtrl"}).when("/starred",{templateUrl:"views/items.html",controller:"StarredCtrl"}).when("/folder/:folderName",{templateUrl:"views/items.html",controller:"FolderCtrl"}).when("/feed/:feedId",{templateUrl:"views/items.html",controller:"FeedCtrl"}).when("/search",{templateUrl:"views/items.html",controller:"SearchCtrl"}).otherwise({redirectTo:"/"})}]).run(["$location","$rootScope","$cookies","$http","ngProgressLite",function(a,b,c,d,e){d.defaults.headers.post["X-CSRFToken"]=c.csrftoken,d.defaults.headers.common["X-CSRFToken"]=c.csrftoken,b.$on("event:auth-loginRequired",function(){window.location="/"}),b.$on("$routeChangeStart",function(){e.start(),e.done()})}]),angular.module("readerApp").controller("MainCtrl",["$scope","User","Articles","$http",function(a,b,c,d){a.loader={spin:!1},b.feeds.then(function(b){a.feeds=b}),a.articles=new c("/api/v1/articles/populars/",null,null,a.loader),a.addFeed=function(a){d.post("/api/v1/account/feeds/"+a+"/",{},{params:{folder:"~~Root"}}).success(function(){b.feeds.then(function(b){d.get("/api/v1/account/feeds/",{params:{feed:a}}).success(function(a){if(a.objects.length>0){var c=a.objects[0];return b.ids.splice(0,0,c.id),b.title[c.id]=c.title,b.favicon[c.id]=c.favicon,"~~Root"===c.folder?b.root.push(c):void 0!==b.folders[c.folder]&&b.folders[c.folder]?b.folders[c.folder].push(c):(b.folders[c.folder]=[],b.folders[c.folder].push(c)),b}})})}).error(function(){})}}]),angular.module("readerApp").controller("AlertsCtrl",["$scope","Alerts",function(a,b){a.alerts=b}]),angular.module("readerApp").controller("ChangefolderCtrl",["$scope","$http","ngProgressLite","User",function(a,b,c,d){a.newFolder=void 0,a.folderChoice=void 0,a.lock=!1,a.folders=d.feeds.then(function(a){var b=[];for(var c in a.folders)b.push(c);return b}),a.save=function(){a.lock||(a.lock=!0,d.feeds.then(function(c){if(void 0!==a.folderChoice||void 0!==a.newFolder){var e;for(var f in c.folders)for(var g=c.folders[f].length-1;g>=0;g--)c.folders[f][g].id===parseInt(d.vars.toMove)&&(e=c.folders[f][g],c.folders[f].splice(g,1));for(var g=c.root.length-1;g>=0;g--)c.root[g].id===parseInt(d.vars.toMove)&&(e=c.root[g],c.root.splice(g,1));void 0!==a.newFolder&&""!==a.newFolder&&(void 0!==c.folders[a.newFolder]&&c.folders[a.newFolder]?e.folder=a.newFolder:c.folders[a.newFolder]=[],e.folder=a.newFolder,c.folders[a.newFolder].push(e)),void 0!==a.folderChoice&&""!==a.folderChoice&&("Main Folder"===a.folderChoice?(e.folder="~~Root",c.root.push(e)):(e.folder=a.folderChoice,c.folders[a.folderChoice].push(e))),b.put("/api/v1/account/feeds/"+e.id+"/",{folder:e.folder}),a.folders=d.feeds.then(function(a){var b=[];for(var c in a.folders)b.push(c);return b}),a.lock=!1,$("#moveModal").modal("hide"),a.newFolder=void 0,a.folderChoice=void 0}}))}}]),angular.module("readerApp").controller("CollapsedCtrl",["$scope","Subscription","$http","User","$timeout","$location",function(a,b,c,d,e,f){a.selected=void 0,a.buttonSubscribe=!1,a.buttonShowSpinner=!0,a.buttonSubscribeText="Add",a.formSubscribedClass=void 0,a.submit=void 0,a.lock=!1,a.$watch(function(){return b.show},function(b){a.show=b}),a.manageTypeahead=function(){void 0!==a.submit&&a.submit()},a.resetTypeahead=function(){a.selected=void 0,a.buttonSubscribe=!1,a.submit=void 0,a.lock=!1,a.buttonSubscribeText="Add"},a.close=function(){b.show=!1},a.typeaheadSearch=function(b){return a.lock?[]:(a.lock=!0,a.resetTypeahead(),b.length>=8&&(S(b).startsWith("http://")||S(b).startsWith("https://"))?(a.buttonSubscribeText="Go",a.submit=a.tryToAdd,a.lock=!1,[]):c.get("/api/v1/feeds/search",{params:{q:b}}).then(function(b){for(var c=[],d=b.data.objects,e=0;e<d.length;e++)c.push(d[e]);return d.length>0&&(a.flood=0),a.lock=!1,c}))},a.tryToAdd=function(){return a.lock?[]:(a.lock=!0,a.buttonSubscribeText='<i class="fa fa-spinner fa-spin" />',a.submit=void 0,c.post("/api/v1/feeds/",{feed:a.selected}).error(function(){return a.formSubscribedClass="has-error",e(a.resetTypeahead,5e3),[]}).then(function(b){return b.data.success?(d.feeds.then(function(c){c.ids.indexOf(b.data.feed_id)>-1?(a.buttonSubscribeText="Show",a.submit=a.manageFeed,a.adding={id:b.data.feed_id},a.mode=0):(a.adding={id:b.data.feed_id},a.buttonFeed=!0,a.buttonFeedClass="btn-success",a.buttonSubscribeText="Add",a.submit=a.manageFeed,a.mode=1)}),a.lock=!1,[b.data]):(a.formSubscribedClass="has-error",e(a.resetTypeahead,5e3),[])}))},a.selectMatch=function(b){d.feeds.then(function(c){a.submit=a.manageFeed,c.ids.indexOf(b.id)>-1?(a.buttonSubscribeText="Show",a.submit=a.manageFeed,a.adding=b,a.mode=0):(a.adding=b,a.buttonSubscribeText="Add",a.mode=1)})},a.manageFeed=function(){return 0===a.mode?(a.resetTypeahead(),a.close(),f.search("q",null).path("/feed/"+a.adding.id).replace()):void 0!==a.adding&&a.lock!==!0&&(a.lock=!0,c.post("/api/v1/account/feeds/"+a.adding.id+"/",{},{params:{folder:"~~Root"}}).success(function(){d.feeds.then(function(b){c.get("/api/v1/account/feeds/",{params:{feed:a.adding.id}}).success(function(a){if(console.log(a),a.objects.length>0){var c=a.objects[0];return b.ids.splice(0,0,c.id),b.ind[c]=!0,b.title[c.id]=c.title,b.favicon[c.id]=c.favicon,"~~Root"===c.folder?b.root.push(c):void 0!==b.folders[c.folder]&&b.folders[c.folder]?b.folders[c.folder].push(c):(b.folders[c.folder]=[],b.folders[c.folder].push(c)),b}})}),a.resetTypeahead(),a.close(),a.lock=!1}).error(function(){})),[]}}]),angular.module("readerApp").controller("FeedCtrl",["$scope","User","Articles","$routeParams","ngProgressLite","Alerts","$http","$location",function(a,b,c,d,e,f,g,h){a.loader={spin:!1},b.feeds.then(function(b){a.feeds=b}),b.info.then(function(b){a.userInfo=b}),b.starred.then(function(b){a.starred=b}),a.thisFeed=d.feedId,a.articles=new c("/api/v1/account/articles/?feed="+d.feedId,null,null,a.loader),a.removeFeed=function(a){e.start(),g.delete("/api/v1/account/feeds/"+a+"/").success(function(){b.feeds.then(function(b){for(var c in b.folders)for(var d=b.folders[c].length-1;d>=0;d--)b.folders[c][d].id===parseInt(a)&&b.folders[c].splice(d,1);for(var d=b.root.length-1;d>=0;d--)b.root[d].id===parseInt(a)&&b.root.splice(d,1);return delete b.ind[a],b.ids.splice(b.ids.indexOf(parseInt(a)),1),b}),h.path("/"),e.done()}).error(function(){f.addAlert("error","There was an error deleting this feed."),e.done()})},a.moveFeed=function(a){b.vars.toMove=a}}]),angular.module("readerApp").controller("FolderCtrl",["$scope","User","Articles","$routeParams",function(a,b,c,d){b.feeds.then(function(b){a.feeds=b}),b.info.then(function(b){a.userInfo=b}),b.starred.then(function(b){a.starred=b}),a.articles=new c("/api/v1/account/articles/?folder="+d.folderName)}]),angular.module("readerApp").controller("HeaderCtrl",["$scope","$location","Subscription","$window","User","ngProgressLite","$http","Alerts",function(a,b){a.searchQuery=void 0,a.searchArticles=function(){b.search("q",a.searchQuery).path("/search").replace(),a.searchQuery=void 0}}]),angular.module("readerApp").controller("ItemsCtrl",["$scope","Articles","User","$timeout",function(a,b,c){a.loader={spin:!1},a.articles=new b(null,null,null,a.loader),c.feeds.then(function(b){a.feeds=b}),c.info.then(function(b){a.userInfo=b}),c.starred.then(function(b){a.starred=b}),a.$watch(function(){return void 0!==a.articles?a.articles.full_count:void 0},function(a){c.vars.items=c.vars.items.then(function(b){return b=a})})}]),angular.module("readerApp").controller("SearchCtrl",["$scope","Articles","$routeParams","User",function(a,b,c,d){a.loader={spin:!1},d.feeds.then(function(b){a.feeds=b}),d.info.then(function(b){a.userInfo=b}),d.starred.then(function(b){a.starred=b}),a.articles=new b("/api/v1/articles/search/",{q:c.q},null,a.loader)}]),angular.module("readerApp").controller("SettingsCtrl",["$scope","User","$http","$window","ngProgressLite","Alerts",function(a,b,c,d,e,f){b.info.then(function(b){a.userInfo=b}),a.changePassword=function(){},a.connectPocket=function(){d.location="/accounts/pocket/"},a.connectEvernote=function(){d.location="/accounts/evernote/"},a.connectReadability=function(){d.location="/accounts/readability/"},a.logout=function(a){c.post("/api/v1/user/extras/",{extra:a,logout:!0}).success(function(){b.info.then(function(b){return delete b.enabled[a],b})})},a.undoAllread=function(){e.start(),c.delete("/api/v1/account/read/").success(function(){b.info.then(function(a){return a.read_from=null,a}),f.addAlert("info","Mark all as read succefully reverted."),e.done()}).error(function(){f.addAlert("error","Whoops. There was an error."),e.done()})},a.showReadItems=function(){e.start(),c.post("/api/v1/user/extras/",{extra:"show_read"}).success(function(){e.done()}).error(function(){e.done(),f.addAlert("error","Whoops. There was an error.")})}}]),angular.module("readerApp").controller("SidebarCtrl",["$scope","User","ngProgressLite",function(a,b){a.vars={},a.userInfo={},b.info.then(function(b){a.userInfo=b}),b.vars.items.then(function(b){b>1e3&&(b="+1k"),a.vars.items=b}),b.vars.stars.then(function(b){a.vars.stars=b}),b.feeds.then(function(b){a.feeds=b})}]),angular.module("readerApp").controller("StarredCtrl",["$scope","User","Articles",function(a,b,c){a.loader={spin:!1},b.feeds.then(function(b){a.feeds=b}),b.info.then(function(b){a.userInfo=b}),b.starred.then(function(b){a.starred=b}),a.articles=new c("/api/v1/account/star/",null,null,a.loader)}]),angular.module("readerApp").service("Alerts",["$timeout",function a(b){var a=function(){this.alerts=[]};return a.prototype.addAlert=function(a,c){var d=this;this.alerts.push({type:a,msg:c}),b(function(){d.alerts.splice(0,1)},5e3)},a.prototype.closeAlert=function(a){this.alerts.splice(a,1)},new a}]),angular.module("readerApp").factory("Articles",["$http","User","$window","ngProgressLite","Alerts",function(a,b,c,d,e){var f=function(a,b,c,d){this.items=[],this.ids={},this.busy=!1,this.after=a||"/api/v1/account/articles/",this.byDate=c===!0,this.date=void 0,this.params=void 0||b,this.loader=d,this.full_count=void 0};return f.prototype.nextPage=function(){return this.busy?(this.loader.spin=!1,void 0):(this.busy=!0,this.loader.spin=!0,a.get(this.after,{params:this.params}).success(function(a){var b=a.objects;if(void 0!==b){if(0===b.length)return this.loader.end=!0,this.loader.spin=!1,void 0;void 0===this.full_count&&(this.full_count=a.meta.total_count);for(var c=0;c<b.length;c++)void 0===this.ids[b[c].id]&&(b[c].date_parsed=b[c].date_parsed+"Z",this.items.push(b[c]),this.ids[b[c].id]=!0);this.after=a.meta.next,this.loader.spin=!1,this.busy=!1}}.bind(this)).error(function(){this.loader.spin=!1}),void 0)},f.prototype.star=function(c){a.post("/api/v1/account/star/"+c+"/",{}).then(function(a){a.data.success&&(b.vars.stars=b.vars.stars.then(function(a){return a+1})),b.starred.then(function(a){return a[c]=!0,a})})},f.prototype.unstar=function(c){a.delete("/api/v1/account/star/"+c+"/",{}).success(function(){b.starred.then(function(a){return delete a[c],a}),b.vars.stars=b.vars.stars.then(function(a){return a-1})})},f.prototype.share=function(b,c){d.start(),a.post("/api/v1/user/extras_share/",{extra:b,article:c}).success(function(){d.done()}).error(function(){d.done(),e.addAlert("error","There was an error saving to your "+b+" account.")})},f.prototype.shareFacebook=function(a){c.open("https://www.facebook.com/sharer/sharer.php?u="+a,"facebook-share-dialog","width=626,height=436")},f.prototype.shareTwitter=function(a){c.open("https://twitter.com/share?url="+a+"&via=readboxapp&text=Just read ","twitter-share-dialog","width=626,height=436")},f.prototype.shareGoogle=function(a){c.open("https://plus.google.com/share?url="+a,"google-share-dialog","width=626,height=436")},f.prototype.read=function(){},f.prototype.unread=function(){},f}]),angular.module("readerApp").service("Subscription",function(){return{show:!1}}),angular.module("readerApp").service("User",["$http",function(a){return{info:a.get("/api/v1/user/").then(function(a){return a.data.objects[0]}),feeds:a.get("/api/v1/account/feeds/?limit=0").then(function(a){for(var b={ids:[],ind:{},favicon:{},title:{},folders:{"Main Folder":!0},root:[]},c=0;c<a.data.objects.length;c++){var d=a.data.objects[c];"~~Root"===d.folder?b.root.push(d):void 0!==b.folders[d.folder]&&b.folders[d.folder]?b.folders[d.folder].push(d):(b.folders[d.folder]=[],b.folders[d.folder].push(d)),b.ids.push(d.id),b.ind[d.id]=!0,b.favicon[d.id]=d.favicon,b.title[d.id]=d.title}return b}),starred:a.get("/api/v1/account/star/ids/").then(function(a){for(var b={},c=0;c<a.data.objects.length;c++)b[a.data.objects[c].article_id]=1;return b}),vars:{items:a.get("/api/v1/account/articles/").then(function(a){return a.data.meta.total_count}),stars:a.get("/api/v1/account/star/").then(function(a){return a.data.meta.total_count})}}}]),angular.module("readerApp").controller("SideiconCtrl",["$scope","Subscription","User","ngProgressLite","Alerts","$http",function(a,b,c,d,e,f){a.vars={},a.toggleCollapse=function(){b.show=!b.show},a.allread=function(){d.start(),f.get("/api/v1/account/articles/").success(function(a){return 0===a.objects.length?(e.addAlert("error","You have already marked all your items as read."),d.done(),void 0):(f.post("/api/v1/account/read/",{read_from:a.objects[0].date_parsed+"Z"}).success(function(){c.info.then(function(a){return a.read_from=!0,a}),e.addAlert("info","All your articles are now marked as read."),d.done()}).error(function(){e.addAlert("error","Whoops. There was an error.")}),void 0)})},a.$watch(function(){return c.vars.items},function(b){b.then(function(b){b>1e3&&(b="+1k"),a.vars.items=b})}),a.$watch(function(){return c.vars.stars},function(b){void 0!==b&&b.then(function(b){a.vars.stars=b})})}]);